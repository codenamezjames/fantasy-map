# City Generation Spec

## Overview

Add a new zoom level that generates detailed city/town layouts when zooming into settlements. Cities include buildings, streets, districts, walls, and integrate with the world map's roads and water features.

**References**:
- [Medieval Fantasy City Generator by watabou](https://watabou.itch.io/medieval-fantasy-city-generator)
- [Road Network Algorithm by Worldsmith](https://zero.re/worldsmith/roadnet/#algo)

---

## Trigger & Generation

### Entry Trigger
- **Zoom threshold**: Automatically transition to city view when zoom exceeds a threshold while centered on a settlement tile
- Threshold varies by POI type (capitals visible earlier than villages)

### Generation Strategy
- **On-demand**: Generate city layout when first viewed
- **Deterministic**: Use seed = `hash(POI.id + world.seed)` for reproducibility
- **No storage needed**: Regenerate from seed each time (same seed = same city)

---

## Coordinate System & Boundaries

### Coordinate Space
- **Embedded in world**: City uses same world coordinate space
- City generation happens within the POI's tile(s)
- No coordinate transformation needed - just zoom into world space

### City Boundary
- **From tile shape**: Use the Voronoi tile polygon as the city boundary
- Streets and buildings are clipped to tile polygon
- For multi-tile cities, union of occupied tiles forms boundary

### Multi-Tile Cities
- **Use existing tileOccupation** from POI config (capital=3 rings, city=2, etc.)
- Large cities span their occupied tile cluster
- **Core + expansion pattern**: Main tile has city center, outer tiles are expansions

---

## City Size & Scale

### Size Calculation
Size determined by **POI type + population**:

| POI Type | Base Size | Population Multiplier | Tile Occupation |
|----------|-----------|----------------------|-----------------|
| Capital  | 100%      | +10% per 1000 pop    | 3 rings         |
| City     | 70%       | +10% per 1000 pop    | 2 rings         |
| Town     | 40%       | +15% per 500 pop     | 1 ring          |
| Village  | 15%       | +20% per 100 pop     | 0 rings         |

Size affects:
- Number of buildings
- Number of wall rings
- District count
- Street recursion depth

---

## Street Network Algorithm

### Algorithm: Planar Graph with Recursive Subdivision
Based on [Worldsmith Road Network](https://zero.re/worldsmith/roadnet/#algo)

### Data Structures
```javascript
StreetNetwork {
  nodes: Map<id, StreetNode>    // Intersections
  edges: Map<id, StreetEdge>    // Street segments
}

StreetNode {
  id: number
  position: [x, y]
  degree: number                // Number of connected edges (max 4)
  type: 'intersection' | 'gate' | 'plaza' | 'dead_end'
}

StreetEdge {
  id: number
  nodeA: number
  nodeB: number
  width: number                 // Street width
  type: 'main' | 'secondary' | 'alley'
}
```

### Generation Algorithm (2 Levels)

**Level 1: Main Roads**
1. Place center node (castle/market position)
2. Place gate nodes where world roads enter tile boundary
3. Generate candidate nodes around center with distance constraints
4. Connect nodes with edges, enforcing:
   - No edge crossings (planar graph)
   - No small angles (minimum ~55-65°)
   - Maximum degree 4 per node
5. Score candidates by alignment and distance
6. Remove isolated nodes

**Level 2: Side Streets**
1. Find faces (enclosed areas) in the graph using cycle-finding
2. For each face larger than threshold:
   - Generate new nodes within face boundary
   - Connect with tighter parameters
   - These become district/side streets

### Constraints
- **Minimum segment length**: `tileWidth / 50` (relative to tile size)
- **Minimum angle**: 55-65° between edges at node
- **Maximum node degree**: 4 (typical intersection)
- **No edge crossings**: Planar embedding required

### Street Types
| Type | Width | Generated By |
|------|-------|--------------|
| Main thoroughfare | 8 units | Level 1: gate → center |
| District street | 5 units | Level 1: secondary |
| Alley | 2 units | Level 2: subdivision |

---

## Districts

### Algorithm: Flood Fill Zones
1. Place district seed points based on rules (castle at defensible point, market at center, etc.)
2. Grow regions from seeds using weighted flood fill
3. Weights consider: distance to seed, terrain, street boundaries
4. Streets act as natural district boundaries

### Full District Set

| District | Description | Building Types |
|----------|-------------|----------------|
| **Castle/Keep** | Ruler's seat, at defensible position | Castle, barracks, armory |
| **Market** | Commercial center | Shops, stalls, warehouses |
| **Temple** | Religious quarter | Temples, shrines, monastery |
| **Residential** | Common housing | Houses, apartments |
| **Noble Quarter** | Wealthy area | Mansions, gardens |
| **Slums** | Poor area, outside walls | Shacks, cramped buildings |
| **Guild** | Craftsmen area | Workshops, guild halls |
| **Warehouse** | Storage/trade | Warehouses, granaries |
| **Military** | Defense | Barracks, training grounds |
| **Entertainment** | Leisure | Taverns, theaters, brothels |
| **Foreign Quarter** | Outsiders/traders | Mixed buildings, exotic shops |
| **Cemetery** | Dead | Graveyard, crypts, chapel |
| **Docks** | Water access (ports only) | Piers, shipyards, fish market |

### District Placement Rules
- Castle at highest/most defensible point
- Market near city center
- Docks along water (rivers/coast)
- Slums outside walls or in undesirable areas
- Noble quarter near castle
- Cemetery outside walls
- Temple prominent but not central

### Multi-Tile District Assignment
- **Core tile**: Castle, market, temple, noble quarter
- **Expansion tiles**: Residential, slums, warehouse, guild, military

---

## Buildings

### Algorithm: Polygon Clipping
1. Street network defines blocks (faces in the planar graph)
2. For each block:
   - Generate building footprints as irregular polygons
   - Clip polygons to block boundary
   - Assign building types based on district
   - Calculate heights based on type

### Building Properties
```javascript
Building {
  id: number
  type: string              // house, shop, temple, tavern, etc.
  footprint: Polygon        // Irregular 2D shape, clipped to block
  height: number            // 1-5 stories, for shadows
  districtId: number
  rotation: number          // Orientation toward street
}
```

### Building Types by District

**Residential**: house, apartment, mansion, shack
**Commercial**: shop, stall, warehouse, inn, tavern
**Religious**: temple, shrine, chapel, monastery
**Military**: barracks, armory, guardhouse, stable
**Civic**: town hall, courthouse, guild hall, prison
**Industrial**: workshop, smithy, mill, tannery
**Special**: castle, palace, lighthouse, theater

### Height Variation
| Stories | Building Types |
|---------|---------------|
| 1 | shacks, stalls, small houses |
| 2 | typical houses, shops |
| 3 | wealthy houses, inns |
| 4+ | temples, guild halls, mansions |
| Tower | castle towers, church spires, lighthouse |

### Rendering Style
- **Solid color blocks** with offset shadow
- Color by district or building type
- Darker roofs, lighter walls
- **Shadow**: Draw dark copy offset down-right based on height

---

## Walls & Gates

### Algorithm: Grid-Snapped
- Walls snap to fine grid (2-4 world units)
- Creates clean, slightly irregular medieval walls
- Grid snapping ensures consistent tower placement

### Adaptive Wall System
| City Size | Wall Rings |
|-----------|-----------|
| Village | 0-1 (palisade if frontier) |
| Town | 1 |
| City | 1-2 |
| Capital | 2-3 |

### Wall Features
- **Gates** positioned where world roads enter
- **Towers** at corners and gate flanks
- **Walls connect to water** for natural defense
- **Inner walls** shorter/older style, outer walls taller

### Village Walls
Based on location safety:
- **Frontier** (near world edge, mountains, dangerous biomes) → palisade
- **Safe interior** → no walls

### Gate Placement
1. Find where world roads intersect tile boundary
2. Place gate at each intersection point
3. Main roads inside city connect gates to center

---

## Water Integration

Rivers running through cities use ALL of these approaches contextually:

### River as Boundary
- City may split into districts on each side
- Each side can have different character

### Bridges
- Streets cross river via bridges
- Main roads get wider stone bridges
- Side streets get smaller wooden bridges
- No buildings in river channel

### River District
- Docks/warehouses line the riverbanks
- Mills along river in industrial areas
- Fishing district near water

### Coastal/Port Cities
- **Docks district** mandatory for ports
- **Harbor** with piers extending into water
- **Shipyards** for larger ports
- **Sea walls** protecting harbor
- **Lighthouse** for capitals/major ports

---

## World Connection

### Street → Road Integration
- **Streets connect to world roads** at tile boundaries
- World roads enter through **city gates**
- Main thoroughfares continue as main streets inside
- Road type (major/minor) affects street width at connection

### Transition at Boundary
- Streets extend to tile edge and connect to world road network
- No hard cutoff - visual continuity between city and world

---

## Rendering & Performance

### Integration with Existing System
- **Extend sub-tile system**: City is another zoom level in existing hierarchy
- Fits into current TileLoadManager architecture
- City generation triggered at zoom threshold

### Performance Optimizations
1. **LOD (Level of Detail)**: Simplify buildings when zoomed out
2. **Viewport culling**: Only render visible buildings/streets
3. **Canvas layers**: Pre-render static parts to offscreen canvas

### Shadow Rendering
- **Offset duplicate**: Draw dark copy of building offset down-right
- Offset distance = `height * shadowScale`
- Shadow color = building color darkened

### City Seed
```javascript
citySeed = hash(poi.id.toString() + world.seed)
```
Same POI + same world seed = identical city every time

---

## POI Type Effects

### Capital
- Larger castle → palace complex
- More wall rings (2-3)
- Wider main streets
- Noble quarter more prominent
- Occupies 3 tile rings

### Port
- Mandatory docks district
- Harbor with piers
- Warehouse district near docks
- Possible lighthouse

### Temple (as POI type)
- Expanded temple district
- Central religious complex
- Pilgrimage facilities (inns, hostels)

---

## Interaction

### Building Click
- Show tooltip with building type
- Format: "Blacksmith", "Tavern", "Temple of Light"
- No custom descriptions in v1 (future feature)

### Navigation
- Pan/zoom within city view (same controls as world)
- Zoom out past threshold returns to world map
- Seamless transition

---

## Technical Architecture

### New Components

```
src/
  generation/
    CityGenerator.js       # Main city generation orchestrator
    StreetGenerator.js     # Planar graph street network
    DistrictGenerator.js   # Flood fill district boundaries
    BuildingGenerator.js   # Polygon clipping building footprints
    WallGenerator.js       # Grid-snapped wall rings and gates
  data/
    City.js               # City data structure
    Building.js           # Building data structure
    District.js           # District data structure
    StreetNetwork.js      # Planar graph for streets
  rendering/
    CityRenderer.js       # City-specific rendering (extends existing)
```

### Generation Pipeline
```
1. Calculate city seed from POI id + world seed
2. Determine city size and tile occupation from POI
3. Get boundary polygon (union of occupied tiles)
4. Identify water features (rivers/coast in boundary)
5. Place city center (castle or market square)
6. Find world road entry points → gate positions
7. Generate Level 1 streets (main roads)
8. Generate Level 2 streets (subdivision)
9. Generate wall ring(s) on grid
10. Assign districts via flood fill
11. Generate buildings in blocks (polygon clipping)
12. Add bridges where streets cross water
13. Add docks if port city
```

### Data Flow
```
POI → CityGenerator.generate(poi, world) → City
City contains: StreetNetwork, District[], Building[], Wall[]
City passed to CityRenderer for drawing
```

---

## Config Options

```yaml
cities:
  # Zoom thresholds to enter city view
  zoomThreshold:
    capital: 70
    city: 75
    town: 80
    village: 85

  # Street generation
  streets:
    mainWidth: 8
    districtWidth: 5
    alleyWidth: 2
    minAngle: 55               # Minimum angle at intersections
    minSegmentRatio: 0.02      # Min segment = tileWidth * ratio

  # Building generation
  buildings:
    density: 0.7               # 0-1, how packed buildings are
    heightVariation: 0.4
    shadowOffset: 2            # Shadow offset per story

  # Wall settings
  walls:
    gridSize: 3                # Fine grid for snapping (2-4 units)
    towerSpacing: 50
    gateWidth: 12

  # District colors (HSL)
  districtColors:
    castle: { h: 0, s: 20, l: 30 }
    market: { h: 40, s: 40, l: 50 }
    temple: { h: 220, s: 30, l: 45 }
    residential: { h: 30, s: 25, l: 55 }
    noble: { h: 280, s: 25, l: 50 }
    slums: { h: 30, s: 15, l: 40 }
    guild: { h: 25, s: 35, l: 45 }
    warehouse: { h: 35, s: 20, l: 40 }
    military: { h: 0, s: 15, l: 35 }
    entertainment: { h: 350, s: 40, l: 50 }
    foreign: { h: 60, s: 30, l: 50 }
    cemetery: { h: 0, s: 0, l: 30 }
    docks: { h: 200, s: 30, l: 45 }
```

---

## Future Features (Not in v1)

- [ ] Custom named buildings in config
- [ ] Building interiors at higher zoom
- [ ] NPC placement
- [ ] Day/night rendering
- [ ] Seasonal variations
- [ ] City growth over time (campaign mode)
- [ ] Procedural building names ("The Rusty Anchor")
- [ ] Street names
- [ ] Fog of war for unexplored areas

---

## Implementation Phases

### Phase 1: Core Structure
- [ ] City and StreetNetwork data models
- [ ] Basic street generation (Level 1 only - main roads)
- [ ] Simple rectangular buildings (no clipping yet)
- [ ] Integrate with sub-tile system at zoom threshold
- [ ] Basic rendering (streets + building rectangles)

### Phase 2: Full Streets & Buildings
- [ ] Level 2 street subdivision
- [ ] Polygon clipping for building footprints
- [ ] Building height and shadow rendering
- [ ] Gate placement from world roads

### Phase 3: Districts & Walls
- [ ] Flood fill district generation
- [ ] Building type assignment by district
- [ ] Grid-snapped wall generation
- [ ] Adaptive wall rings based on city size
- [ ] Tower placement

### Phase 4: Water & Polish
- [ ] River detection and bridge placement
- [ ] Docks district for ports
- [ ] Building click interaction
- [ ] LOD optimization
- [ ] Config options
- [ ] POI type effects (capital palace, port lighthouse, etc.)
